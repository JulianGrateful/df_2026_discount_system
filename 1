<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Commercial Intelligence OS 2026 Matrix Engine 5.4.html</title>
    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-sidebar: rgba(245, 245, 247, 0.85);
            --apple-card: #ffffff;
            --apple-blue: #007aff;
            --apple-green: #34c759;
            --apple-red: #ff3b30;
            --apple-text: #1d1d1f;
            --apple-secondary: #86868b;
            --apple-border: rgba(0,0,0,0.1);
            --glass: blur(25px) saturate(190%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--apple-bg); color: var(--apple-text);
            margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column;
            overflow-y: auto; /* –í–µ—Ä–Ω—É–ª–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: var(--glass);
            border-bottom: 0.5px solid var(--apple-border);
            padding: 12px; display: flex; justify-content: center; position: sticky; top: 0; z-index: 1000;
        }
        .tab-switcher { background: rgba(118, 118, 128, 0.12); border-radius: 10px; padding: 2px; display: flex; width: 500px; }
        .tab-btn { flex: 1; border: none; padding: 7px 0; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; background: transparent; transition: 0.2s; }
        .tab-btn.active { background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .app-container { display: grid; grid-template-columns: 320px 1fr; min-height: calc(100vh - 58px); }

        /* Sidebar */
        .sidebar { background: var(--apple-sidebar); backdrop-filter: var(--glass); border-right: 0.5px solid var(--apple-border); padding: 24px; }
        .sidebar-section { margin-bottom: 30px; }
        .sidebar-section h3 { font-size: 10px; font-weight: 700; color: var(--apple-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 15px; }

        .input-group { background: rgba(255,255,255,0.5); border-radius: 12px; padding: 10px 14px; margin-bottom: 10px; border: 0.5px solid rgba(0,0,0,0.05); }
        .input-group label { font-size: 10px; font-weight: 600; color: var(--apple-secondary); display: block; margin-bottom: 4px; }
        .input-group input, .input-group select { border: none; background: transparent; width: 100%; font-size: 17px; font-weight: 600; outline: none; color: var(--apple-text); }

        /* iOS Switch */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.4); border-radius: 12px; padding: 12px; margin-bottom: 6px; }
        .toggle-row span { font-size: 13px; font-weight: 500; }
        .switch { position: relative; width: 42px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--apple-green); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Tooltip */
        .info {
            display: inline-flex; width: 15px; height: 15px; background: #e8e8ed; color: #888; border-radius: 50%; font-size: 10px; align-items: center; justify-content: center; cursor: help; margin-left: 6px; position: relative;
        }
        .info:hover::after {
            content: attr(data-tip); position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); background: #1d1d1f; color: #fff; padding: 12px; border-radius: 9px; width: 240px; font-size: 11px; font-weight: 400; line-height: 1.4; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Waterfall UI */
        .main-content { padding: 40px; background: #fff; }
        .step-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; border-radius: 14px; margin-bottom: 8px; background: #fdfdfd; border: 1px solid #f2f2f7; font-size: 14px; }
        
        .checkpoint { 
            background: rgba(29, 29, 31, 0.03); border-radius: 16px; padding: 20px; margin: 20px 0;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 700; font-size: 16px; color: var(--apple-text);
        }
        .checkpoint-bonus { background: rgba(52, 199, 89, 0.05); border: 1px solid rgba(52, 199, 89, 0.1); color: #166534; }
        .checkpoint-label { font-size: 11px; color: var(--apple-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; font-weight: 600; }

        /* Matrix Configurator */
        .matrix-stage { background: #f5f5f7; border: 2px dashed #d2d2d7; border-radius: 22px; padding: 20px; margin-bottom: 25px; min-height: 100px; display: flex; gap: 12px; flex-wrap: wrap; }
        .block-unit { 
            background: #fff; border-radius: 14px; padding: 16px; width: 250px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: grab;
        }
        .block-unit:active { cursor: grabbing; }

        .btn-action { background: var(--apple-blue); color: #fff; border: none; border-radius: 12px; padding: 12px 24px; font-weight: 600; cursor: pointer; transition: 0.2s; width: 100%; }

        /* Reference Box */
        .reference-box {
            margin-top: 30px; background: #fbfbfd; border-radius: 20px; padding: 25px; border: 1px solid #f2f2f7;
        }
        .ref-item { margin-bottom: 15px; }
        .ref-title { font-weight: 700; font-size: 13px; color: var(--apple-blue); margin-bottom: 5px; display: block;}
        .ref-text { font-size: 12px; line-height: 1.5; color: var(--apple-secondary); }

        .view-pane { display: none; }
        .view-pane.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="header">
        <div class="tab-switcher">
            <button class="tab-btn active" onclick="switchTab('dealer')">–î–∏–ª–µ—Ä</button>
            <button class="tab-btn" onclick="switchTab('mgmt')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            <button class="tab-btn" onclick="switchTab('config')">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä</button>
        </div>
    </div>

    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>–û–±—ä–µ–º –∑–∞–∫—É–ø–∞</h3>
                <div class="input-group">
                    <label>–°—É–º–º–∞ –ø–æ –ø—Ä–∞–π—Å—É, —Å—É–º <span class="info" data-tip="–û–±—ä–µ–º –∑–∞–∫–∞–∑–∞ –≤ –¥–∏–ª–µ—Ä—Å–∫–∏—Ö —Ü–µ–Ω–∞—Ö.">?</span></label>
                    <input type="text" id="base_display" value="160 000 000" oninput="formatAndRun(this)">
                </div>
            </div>

            <div class="sidebar-section">
                <h3>–û–ø—Ü–∏–∏ –¥–∏–ª–µ—Ä–∞</h3>
                <div id="dynamic_options"></div>
            </div>

            <div id="mgmt_tools" style="display:none;">
                <div class="sidebar-section">
                    <h3>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                    <div class="input-group">
                        <label>–ù–∞—Ü–µ–Ω–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä % <span class="info" data-tip="–ú–∞—Ä–∂–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—ã –∑–∞–∫—É–ø–∞.">?</span></label>
                        <input type="number" id="markup_in" value="80" oninput="run()">
                    </div>
                    <div class="input-group">
                        <label>–°—Ç–æ–∏–º–æ—Å—Ç—å 1 —Ä–µ–π—Å–∞</label>
                        <input type="number" id="log_per" value="1200000" oninput="run()">
                    </div>
                    <div class="input-group">
                        <label>–ö–æ–ª-–≤–æ —Ä–µ–π—Å–æ–≤</label>
                        <input type="number" id="log_trips" value="1" oninput="run()">
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div id="v_dealer" class="view-pane active">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <div style="background: #fbfbfd; padding: 25px; border-radius: 20px; border: 1px solid #f2f2f7;">
                        <span class="checkpoint-label">–ù–∞—Ü–µ–Ω–∫–∞ —Ä–æ–∑–Ω–∏—Ü—ã (15%) <span class="info" data-tip="(Base / 0.85) - Base. –î–æ—Ö–æ–¥ –¥–∏–ª–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–µ –ø–æ –†–†–¶.">?</span></span>
                        <div style="font-size: 32px; font-weight: 700; color: var(--apple-blue);" id="d_retail_val">0</div>
                    </div>
                    <div style="background: #fbfbfd; padding: 25px; border-radius: 20px; border: 1px solid #f2f2f7;">
                        <span class="checkpoint-label">–í–∞—à–∞ –∏—Ç–æ–≥–æ–≤–∞—è –≤—ã–≥–æ–¥–∞ <span class="info" data-tip="–°—É–º–º–∞ —Å–∫–∏–¥–æ–∫ –≤ —Å—á–µ—Ç–µ –∏ –∫—ç—à–±—ç–∫–∞ –Ω–∞ —Ä/—Å.">?</span></span>
                        <div style="font-size: 32px; font-weight: 700; color: var(--apple-green);" id="d_benefit_val">0</div>
                    </div>
                </div>
                <h2 style="font-size: 18px; margin-bottom: 20px;">–ö–∞—Å–∫–∞–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h2>
                <div id="d_waterfall"></div>

                <div class="reference-box">
                    <div class="ref-item">
                        <span class="ref-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ (–î–µ–¥–ª–∞–π–Ω)</span>
                        <p class="ref-text">–í—ã–ø–ª–∞—Ç–∞ –∑–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É. –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã —Å—á–µ—Ç–∞. –í–∞—Ä–∏–∞–Ω—Ç—ã: 30 –¥–Ω–µ–π (4%), 40 –¥–Ω–µ–π (3%), 60 –¥–Ω–µ–π (2%).</p>
                    </div>
                    <div class="ref-item">
                        <span class="ref-title">–†–æ—Å—Ç LFL (+1%)</span>
                        <p class="ref-text">Like-for-Like –±–æ–Ω—É—Å –∑–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ. –ù–∞—á–∏—Å–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ –æ–±—ä–µ–º –∑–∞–∫—É–ø–∞ –≤—ã—Ä–æ—Å –Ω–∞ 15% –∫ –ø—Ä–æ—à–ª–æ–º—É –ø–µ—Ä–∏–æ–¥—É.</p>
                    </div>
                </div>
            </div>

            <div id="v_mgmt" class="view-pane">
                <h2 style="font-size: 22px; margin-bottom: 30px;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç–∏</h2>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px;">
                    <div style="background:#fbfbfd; padding:20px; border-radius:20px; border-left:4px solid var(--apple-green);">
                        <span class="checkpoint-label">–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å <span class="info" data-tip="(1–° - –í—ã–ø–ª–∞—Ç—ã) - –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å - –õ–æ–≥–∏—Å—Ç–∏–∫–∞.">?</span></span>
                        <div style="font-size:22px; font-weight:700;" id="m_profit_val">0</div>
                    </div>
                    <div style="background:#fbfbfd; padding:20px; border-radius:20px;"><span class="checkpoint-label">ROS (–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å) <span class="info" data-tip="–ü—Ä–∏–±—ã–ª—å / –ß–∏—Å—Ç–∞—è –≤—ã—Ä—É—á–∫–∞.">?</span></span><div style="font-size:22px; font-weight:700;" id="m_ros_val">0%</div></div>
                    <div style="background:#fbfbfd; padding:20px; border-radius:20px;"><span class="checkpoint-label">–≠—Ñ—Ñ. —Å–∫–∏–¥–∫–∞ <span class="info" data-tip="–†–µ–∞–ª—å–Ω–æ–µ —Å–Ω–∏–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ—Ç –±–∞–∑—ã.">?</span></span><div style="font-size:22px; font-weight:700; color:var(--apple-blue);" id="m_eff_val">0%</div></div>
                </div>
                <div id="m_audit_details" style="background:#fbfbfd; padding:30px; border-radius:24px; line-height:2.6; font-size:15px; border:1px solid #f2f2f7;"></div>
            </div>

            <div id="v_config" class="view-pane">
                <h2 style="font-size: 22px; margin-bottom: 20px;">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ç–æ—Ä –ú–∞—Ç—Ä–∏—Ü—ã</h2>
                <div id="matrix_box"></div>
                <button class="btn-action" style="width:auto; background:#eee; color:#000;" onclick="addStep()">+ –ù–æ–≤—ã–π —ç—Ç–∞–ø –∫–∞—Å–∫–∞–¥–∞</button>
            </div>
        </div>
    </div>

    <script>
        let state = {
            base: 160000000, markup: 80, logPer: 1200000, logTrips: 1,
            matrix: [
                [ { id: 'vol', name: '–°–∫–∏–¥–∫–∞ –∑–∞ –æ–±—ä–µ–º', val: 0, type: 'discount', active: true, isAuto: true }, { id: 'pre', name: '–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 100%', val: 2, type: 'discount', active: false } ],
                [ { id: 'pap', name: '–ë—É–º–∞–≥–∞ Svetocopy', val: 1, type: 'discount', active: false } ],
                [ { id: 'mkt', name: '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ (–î–µ–¥–ª–∞–π–Ω)', val: 4, type: 'payout', active: false } ],
                [ { id: 'lfl', name: '–†–æ—Å—Ç LFL (+1%)', val: 1, type: 'payout', active: false } ]
            ]
        };

        const f = n => new Intl.NumberFormat('ru-RU').format(Math.round(n)) + ' —Å—É–º';

        function formatAndRun(el) {
            let val = el.value.replace(/\s/g, '');
            if (!isNaN(val)) {
                state.base = parseFloat(val) || 0;
                el.value = new Intl.NumberFormat('ru-RU').format(state.base);
                run();
            }
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('v_'+t).classList.add('active');
            document.getElementById('mgmt_tools').style.display = (t!=='dealer'?'block':'none');
            if(t==='config') renderMatrix();
            run();
        }

        function getVolP(sum) {
            if (sum >= 150000000) return 11;
            if (sum >= 100000000) return 9;
            if (sum >= 50000000) return 7;
            if (sum >= 25000000) return 5;
            if (sum >= 10000000) return 3;
            if (sum >= 5000000) return 2;
            return 0;
        }

        function run() {
            state.markup = parseFloat(document.getElementById('markup_in').value) || 0;
            state.logPer = parseFloat(document.getElementById('log_per').value) || 0;
            state.logTrips = parseFloat(document.getElementById('log_trips').value) || 0;

            let current = state.base;
            let totalPayouts = 0;
            let discHtml = `<div class="step-row" style="background:#f9f9fb; border:none;"><span>–ë–∞–∑–∞ –∑–∞–∫—É–ø–∞ (–í—Ö–æ–¥)</span> <b>${f(state.base)}</b></div>`;
            let payHtml = ``;

            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç—É–º–±–ª–µ—Ä–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä–µ
            state.matrix.forEach(row => {
                row.forEach(b => {
                    const tg = document.getElementById('tg_' + b.id);
                    if (tg) b.active = tg.checked;
                });
            });

            // 1. –ö–∞—Å–∫–∞–¥ —Å–∫–∏–¥–æ–∫
            state.matrix.forEach(row => {
                let rowD = 0; let activeD = [];
                row.forEach(b => {
                    if(b.active && b.type === 'discount') {
                        if(b.isAuto) b.val = getVolP(state.base);
                        rowD += parseFloat(b.val);
                        activeD.push(`${b.name} (${b.val}%)`);
                    }
                });
                if(rowD > 0) {
                    let amt = current * (rowD/100);
                    current -= amt;
                    discHtml += `<div class="step-row"><span>${activeD.join(' + ')}</span> <b style="color:var(--apple-red)">‚Äì${f(amt)}</b></div>`;
                }
            });

            const invoiceSum = current;

            // 2. –ö–∞—Å–∫–∞–¥ –≤—ã–ø–ª–∞—Ç
            state.matrix.forEach(row => {
                let rowP = 0; let activeP = [];
                row.forEach(b => {
                    if(b.active && b.type === 'payout') {
                        rowP += parseFloat(b.val);
                        activeP.push(`${b.name} (${b.val}%)`);
                    }
                });
                if(rowP > 0) {
                    let amt = invoiceSum * (rowP/100);
                    totalPayouts += amt;
                    payHtml += `<div class="step-row" style="border-left: 4px dashed var(--apple-green)"><span>–ë–æ–Ω—É—Å: ${activeP.join(' + ')}</span> <b style="color:var(--apple-green)">+${f(amt)}</b></div>`;
                }
            });

            const netRevenue = invoiceSum - totalPayouts;
            const costSum = state.base / (1 + (state.markup / 100));
            const logSum = state.logPer * state.logTrips;
            const profit = netRevenue - costSum - logSum;

            document.getElementById('d_waterfall').innerHTML = discHtml + 
                `<div class="checkpoint"><div><span class="checkpoint-label">–ò—Ç–æ–≥–æ –≤ 1–°</span>–°—É–º–º–∞ –ø–æ —Å—á–µ—Ç—É</div> <span>${f(invoiceSum)}</span></div>` +
                (payHtml ? `<div style="font-size:11px; font-weight:700; color:var(--apple-secondary); margin-top:20px; text-transform:uppercase;">–ö –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—é –Ω–∞ —Ä/—Å:</div>` + payHtml +
                `<div class="checkpoint checkpoint-bonus"><div><span class="checkpoint-label">–í—ã–ø–ª–∞—Ç–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—É</span>–ë–æ–Ω—É—Å—ã –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞</div> <span>${f(totalPayouts)}</span></div>` : '');

            document.getElementById('d_retail_val').innerText = f((state.base/0.85) - state.base);
            document.getElementById('d_benefit_val').innerText = f((state.base - invoiceSum) + totalPayouts);
            
            document.getElementById('m_profit_val').innerText = f(profit);
            document.getElementById('m_ros_val').innerText = (netRevenue > 0 ? (profit/netRevenue*100).toFixed(1) : 0) + '%';
            document.getElementById('m_eff_val').innerText = ((state.base - netRevenue)/state.base*100).toFixed(1) + '%';

            document.getElementById('m_audit_details').innerHTML = `
                üîπ –ò—Ç–æ–≥–æ –≤ 1–°: <b>${f(invoiceSum)}</b><br>
                üí∏ –í—ã–ø–ª–∞—Ç—ã –ø–∞—Ä—Ç–Ω–µ—Ä—É: <span style="color:var(--apple-red)">‚Äì${f(totalPayouts)}</span><br>
                üìâ –ß–∏—Å—Ç–∞—è –≤—ã—Ä—É—á–∫–∞ (Net): <b>${f(netRevenue)}</b><br>
                üè≠ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏ –Ω–∞—Ü–µ–Ω–∫–µ ${state.markup}%: ‚Äì${f(costSum)}<br>
                üöö –õ–æ–≥–∏—Å—Ç–∏–∫–∞ (${state.logTrips} —Ä. √ó ${f(state.logPer)}): ‚Äì${f(logSum)}<br>
                <hr style="border:none; border-top:1px solid #eee; margin:15px 0;">
                üèÅ <b>–í–∞–ª–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å: ${f(profit)}</b>
            `;
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –°–∞–π–¥–±–∞—Ä–∞ (—á—Ç–æ–±—ã –Ω–æ–≤—ã–µ –±–ª–æ–∫–∏ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å)
            renderSwitches();
        }

        function renderSwitches() {
            const area = document.getElementById('dynamic_options');
            let h = '';
            state.matrix.forEach(row => row.forEach(b => {
                h += `<div class="toggle-row"><span>${b.name} ${b.isAuto ? '(–ê–≤—Ç–æ)' : ''}</span> <label class="switch"><input type="checkbox" id="tg_${b.id}" ${b.active?'checked':''} onchange="run()"><span class="slider"></span></label></div>`;
            }));
            area.innerHTML = h; // –£–±—Ä–∞–ª —É—Å–ª–æ–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª–∏–Ω—ã –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–ª–æ–∫–æ–≤
        }

        function renderMatrix() {
            const box = document.getElementById('matrix_box'); box.innerHTML = '';
            state.matrix.forEach((st, si) => {
                const row = document.createElement('div');
                row.className = 'matrix-stage';
                row.ondragover = e => e.preventDefault();
                row.ondrop = e => {
                    e.preventDefault();
                    const data = JSON.parse(e.dataTransfer.getData('text'));
                    const dragged = state.matrix[data.si].splice(data.bi, 1)[0];
                    state.matrix[si].push(dragged);
                    state.matrix = state.matrix.filter((r, i) => r.length > 0 || i === state.matrix.length - 1);
                    renderMatrix(); run();
                };

                row.innerHTML = `<button class="btn-action" style="padding:4px 10px; font-size:10px; margin-bottom:10px;" onclick="addB(${si})">+ –ë–ª–æ–∫</button><br>`;
                st.forEach((bk, bi) => {
                    const el = document.createElement('div');
                    el.className = 'block-unit';
                    el.draggable = true;
                    el.ondragstart = e => e.dataTransfer.setData('text', JSON.stringify({si, bi}));
                    el.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <input style="font-weight:700; border:none; width:75%; outline:none;" value="${bk.name}" oninput="state.matrix[${si}][${bi}].name=this.value; run();">
                            <button style="color:red; border:none; background:none; cursor:pointer;" onclick="remB(${si},${bi})">‚úï</button>
                        </div>
                        <div style="margin-top:10px; display:flex; gap:8px;">
                            <input type="number" step="0.1" style="width:60px; border-radius:6px; border:1px solid #ddd; padding:4px;" value="${bk.val}" oninput="state.matrix[${si}][${bi}].val=this.value; run();"> %
                            <select onchange="state.matrix[${si}][${bi}].type=this.value; run();" style="flex:1; border-radius:6px; font-size:11px;">
                                <option value="discount" ${bk.type==='discount'?'selected':''}>–°–∫–∏–¥–∫–∞</option>
                                <option value="payout" ${bk.type==='payout'?'selected':''}>–í—ã–ø–ª–∞—Ç–∞</option>
                            </select>
                        </div>
                    `;
                    row.appendChild(el);
                });
                box.appendChild(row);
            });
        }

        function addStep() { state.matrix.push([]); renderMatrix(); }
        function addB(si) { 
            state.matrix[si].push({ id: 'b'+Date.now(), name: '–ù–æ–≤–∞—è –æ–ø—Ü–∏—è', val: 0, type: 'discount', active: false }); 
            renderMatrix(); 
            run(); // –¢–µ–ø–µ—Ä—å run() –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç —Å–∞–π–¥–±–∞—Ä
        }
        function remB(si, bi) { state.matrix[si].splice(bi, 1); renderMatrix(); run(); }

        run();
    </script>
</body>
</html>
